<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì ìˆ˜í•¨ ê²Œì„</title>
    <style>
        body {
            background-color: cornsilk;
        }

        canvas {
            /* ìº”ë²„ìŠ¤ ì˜ì—­ ë°°ê²½ */
            background-color: #0099FF;
        }
    </style>
</head>

<body>
    <canvas id="canvas" width="800" height="600"></canvas>
    <script>
        // ìº”ë²„ìŠ¤ ê°ì²´
        var canvas;
        var ctx;
        var canvasBuffer;
        var bufferCtx;
        var threadSpeed = 16;

        // ì ìˆ˜í•¨
        var submarine;
        var sx, sy, sw = 60, sh = 35;

        // ë°°ê²½ì´ë¯¸ì§€
        var background;

        // ì¥ì• ë¬¼
        var enemy = new Array();
        var enemyColor = ['red', 'blue', 'green'];
        var ellapse = 10;

        // íƒ€ì´ë¨¸
        var loopInstance;

        // ê²Œì„ì˜ ìƒíƒœ
        var STATE_START = false;
        var STATE_GAMEOVER = false;

        // í‚¤ ìƒíƒœ(ê²Œì„ì‹œì‘: enter, ê²Œì„ë‹¤ì‹œì‹œì‘:space , ë°©í–¥í‚¤(4ê°œ))
        var keyPressed = []

        // ê²½ê³¼ ì‹œê°„
        var oldTime;
        var startTime;
        var totalTime;

        // ì´ë²¤íŠ¸ ë“±ë¡
        window.addEventListener('load', initialize, false);
        window.addEventListener('keydown', getKeyDown, false);
        window.addEventListener('keyup', getKeyUp, false);


        function initialize() {
            canvas = document.getElementById('canvas');
            if (canvas == null || canvas.getContext == null)
                return
            ctx = canvas.getContext('2d');

            canvasBuffer = document.createElement('canvas');
            canvasBuffer.width = canvas.width;
            canvasBuffer.height = canvas.height;
            bufferCtx = canvasBuffer.getContext('2d');

            // ê²Œì„ ì‹œì‘ ë©”ì„¸ì§€
            startMessage();

            // ì´ë¯¸ì§€ ì„¤ì •
            setImage();

            // ë°˜ë³µ ë™ì‘ ì„¤ì •
            loopInstance = setInterval(update, threadSpeed);


        }
        function startGame() {
            STATE_START = true;

            // ìºë¦­í„° ì´ˆê¸° ìœ„ì¹˜, sxì— ì €ì¥í• ê²ƒì„
            sx = canvas.width / 2;
            sy = canvas.height / 2; // ì ìˆ˜í•¨ì˜ ìœ„ì¹˜ëŠ” í™”ë©´ì˜ ê°€ìš´ë°.
            sw = 60;  // ì ìˆ˜í•¨ ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆ
            sh = 35;

            // ì¥ì• ë¬¼ ìƒì„±
            createObstacle();

            // í˜„ì¬ ì‹œê°„ ì €ì¥
            // í˜„ì¬ ê²Œì„ì„ ì‹œì‘í•œ ì‹œê°„ì—ì„œ ê³„ì† í˜„ì¬ ì‹œê°„ì—ì„œ ê³ ì •ë˜ì–´ìˆëŠ” ì‹œê°„ì„ ë»¼..?
            startTime = getTime();
        }

        function getTime() {
            var date = new Date();
            var time = date.getTime();
            delete date;
            return time;
        }

        function update() {
            if ((keyPressed[13] == true) && (STATE_START == false)) {

                console.log("ê²Œì„ì‹œì‘");
                //ê²Œì„ ì‹œì‘
                startGame();

            }


            if (keyPressed[38]) {
                //ìœ„ìª½ ë°©í–¥í‚¤ë¥¼ ëˆŒë €ì„ë•Œ
                // ì ìˆ˜í•¨ ì¢Œí‘œë¥¼ s, y ì˜ 
                sy = sy - 2;
                //sy = sy - 10;

            }
            if (keyPressed[40]) {
                sy = sy + 2;
            }
            if (keyPressed[37]) {
                //ì™¼ìª½ í‚¤
                sx = sx - 2;
            }
            if (keyPressed[39]) {
                //ì˜¤ë¥¸ìª½
                sx = sx + 2;
            }
            if (keyPressed[32] == true) {
                document.location.reload();
                startGame();
            }

            if (STATE_START) {
                // ì¥ì• ë¬¼ ì´ë™
                moveObstacle(ellapse);

                // ê·¸ë¦¼ ê·¸ë¦¬ê¸°
                drawAll();
            }

        }


        function moveObstacle(ellapse) {
            for (var i = 0; i < 60; i++) {
                // ì´ë™í•œ xì¢Œí‘œê°€ ë‚˜ì˜´
                var mx = enemy[i].vx * ellapse / 1000;
                // yì¢Œí‘œ
                var my = enemy[i].vy * ellapse / 1000;

                enemy[i].x = enemy[i].x + mx;
                enemy[i].y = enemy[i].y + my;


                // 801ì´ ë˜ë²„ë¦¬ëŠ” ìˆœê°„ ë‹¤ì‹œ 0ìœ¼ë¡œ ë³´ëƒ„
                if (enemy[i].x > canvas.width)
                    enemy[i].x = 0;

                // 0ë³´ë‹¤ ì‘ìœ¼ë©´ 
                if (enemy[i].x < 0)
                    enemy[i].x = canvas.width;

                if (enemy[i].y > canvas.height)
                    enemy[i].y = 0;

                if (enemy[i].y < 0)
                    enemy[i].y = canvas.height;

                // ì¶©ëŒ ê²€ì‚¬
                crashObstacle(i);
            }
        }
        function crashObstacle(index) {
            // í˜„ì¬ ë‚´ ìœ ë‹›ê³¼ ì¶©ëŒí–ˆëŠ”ì§€ ê²€ì‚¬
            console.log("í•´ë‹¹ ì¥ì• ë¬¼?", index)
            var mx = enemy[index].x;
            var my = enemy[index].y;

            // ì ìˆ˜í•¨ì˜ í˜„ì¬ ìœ„ì¹˜
            // sw ì ìˆ˜í•¨ì˜ ë„ˆë¹„
            if (mx > sx - sw / 2 && mx < sx + sw / 2 && my > sy - sh / 2 && my < sy + sh / 2) {
                STATE_GAMEOVER = true;
            }


        }

        function createObstacle() {
            //60ê°œì˜ ì¥ì• ë¬¼ ë§Œë“¤ê²ƒì„..
            enemy.length = 0;
            for (var i = 0; i < 60; i++) {
                // enemyëŠ” ë°°ì—´ì„.
                enemy.push(
                    //ì˜¤ë¸Œì íŠ¸ í˜•íƒœë¡œ 
                    { // 60ê°œ í•˜ë‚˜í•˜ë‚˜ê°€ ì´ëŸ°ì •ë³´ë¥¼ ê°€ì§€ê³  ì‡ì„ê²ƒì´ë‹¤.
                        // xì¶•ì´ 800 ì–´ëŠ í•œì§€ì ì— ì°íê²ƒì„
                        x: Math.random() * canvas.width,
                        // 0 ~29ê¹Œì§„ì€ 
                        y: (i < 30) ? 20 : canvas.height - 20,
                        vx: Math.random() * 200 - 100,
                        vy: Math.random() * 200 - 100,
                        color: Math.floor(Math.random() * 3)
                    }
                )
            }
        }

        function drawAll() {
            if (!STATE_START) {
                // ê²Œì„ ì‹œì‘ì „
                return;
            } else if (STATE_GAMEOVER) {
                // ê²Œì„ì´ ëë‚œê²½ìš°, ê²Œì„ ì˜¤ë²„ ë©”ì‹œì§€
                STATE_START = false;
                drawText("bold 30px arial", "#ffff00", "center", "Game OverğŸ’¥", 60);
                drawText("bold 20px arial", "#ffffff", "center", "Spacebar to restart", 20);

            } else {
                // ê²Œì„ ì‹œì‘ ì‹œ ì—”í„°í‚¤ë¥¼ ëˆŒë €ì„ ë–¼
                // ë°°ê²½, ì ìˆ˜í•¨ì´ë¯¸ì§€ ì¶œë ¥
                bufferCtx.drawImage(background, 0, 0);
                bufferCtx.drawImage(submarine, sx - sw / 2, sy - sh / 2);
                ctx.drawImage(canvasBuffer, 0, 0);

                // ì¥ì• ë¬¼ ì¶œë ¥
                drawObstacle();

                totalTime = getTime() - startTime;
                ctx.font = "bold 20px arial";
                ctx.fillStyle = "#ffff00";
                ctx.textAlign = "center";
                ctx.fillText(totalTime, canvas.width - 30, 30)


            }
        }

        // ì¥ì• ë¬¼ ì¶œë ¥
        function drawObstacle() {
            for (var i = 0; i < 60; i++) {
                ctx.beginPath()
                ctx.arc(enemy[i].x, enemy[i].y, 5, 0, 2 * Math.PI);
                ctx.fillStyle = enemyColor[enemy[i].color];
                ctx.closePath();
                ctx.fill();
            }
        }

        function getKeyDown(event) {
            // í‚¤ë¥¼ ëˆŒë €ì„ ë•Œ í‚¤ë‹¤ìš´ì— ëŒ€í•œ ì •ë³´ê°€ ì—¬ê¸°
            console.log(event);
            keyPressed[event.keyCode] = true;


        }

        function getKeyUp(event) {
            // í‚¤ ë–¼ëŠ” ìˆœê°„ false
            keyPressed[event.keyCode] = false;

        }

        function setImage() {
            submarine = new Image();
            submarine.src = "image/jamsuham.png";
            background = new Image();
            background.src = "image/sea.jpg"
        }

        function drawText(font, color, align, text, ygap) {
            ctx.font = font;
            ctx.fillStyle = color;
            ctx.textAlign = align;
            ctx.fillText(text, canvas.width / 2, canvas.height / 2 - ygap)
        }

        function startMessage() {
            drawText("bold 30px arial", "#ffff00", "center", "Enter To Start", 60);
            // ì¡°ì‘ ë°©í–¥í‚¤ ì„¤ëª… ë‚´ìš© ì‘ê²Œí• ê±°ì„.
            drawText("bold 20px arial", "#ffffff", "center", "ì¡°ì‘ ë°©í–¥í‚¤ â†â†‘â†’â†“", 20);
        }



    </script>
</body>

</html>